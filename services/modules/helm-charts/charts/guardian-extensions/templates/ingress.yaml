apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
    name: guardian-ingress
    annotations:
        nginx.ingress.kubernetes.io/use-regex: "true"
        nginx.ingress.kubernetes.io/rewrite-target: /$2
        nginx.ingress.kubernetes.io/enable-rewrite-log: "true"
        nginx.ingress.kubernetes.io/proxy-connect-timeout: "180"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "180"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "180"
        nginx.ingress.kubernetes.io/proxy-body-size: 20m
        # nginx.ingress.kubernetes.io/auth-type: basic
        # nginx.ingress.kubernetes.io/auth-secret: {{.Release.Name}}-tymlez-basic-auth
        # nginx.ingress.kubernetes.io/whitelist-source-range: "{{.Values.global.guardian.whitelistedIps}}"
spec:
    ingressClassName: 'nginx'
    rules:
      #- host: "{{ .Values.global.host}}"
      - http:
          paths:
            - path: /api/v1(/|$)(.*)
              pathType: Prefix
              backend:
                service:
                  name: {{ .Release.Name }}-guardian-api-gateway-{{ .Release.Revision }}
                  port:
                    number: 3002
            - path: /?(/|$)(.*)
              pathType: Prefix
              backend:
                service:
                  name: {{ .Release.Name }}-guardian-web-proxy
                  port:
                    number: 80